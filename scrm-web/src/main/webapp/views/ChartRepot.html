<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <title>统计图表</title>

    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/chart.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/layui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/modules/layer/default/layer.css}">

    <script type="text/javascript" th:src="@{/resources/js/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/resources/js/echarts.js}"></script>
    <script type="text/javascript" th:src="@{/resources/js/layui.js}" charset="UTF-8"></script>
    <script type="text/javascript" th:src="@{/resources/layer/layer.js}"></script>

</head>

<body>

<div th:replace="index.html">
</div>

 <div class="container">
        <div class="top" style="height: 290px;overflow: auto">
            <!--<form class="form-inline" id="myform" method="post" style="margin-top: 10px">-->
            <!--<div >-->
                <!--<div class="form-group" style="margin-top: 10px;margin-left: 10px">-->
                    <!--<label for="saleman">业务员 </label>-->
                    <!--<select class="form-control" id="saleman" name="saleman" style="width: 100px">-->
                        <!--<option></option>-->
                        <!--<option th:each="c:${userSales}" th:value="${c}" th:text="${c}"></option>-->
                    <!--</select>-->
                    <!--<input id="linkUpCus" class="btnStyle" type="button" value="沟通记录" onclick="btnOpenComRecord()">-->
                <!--</div>-->
            <!--</div>-->
            <!--</form>-->
            <table class="layui-hide" id="reportext" lay-filter="reportext"></table>
        </div>
        <div class="bottom" id="main" style="height: 300px;overflow: auto">
        </div>
    </div>

</body>

<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-xs" lay-event="edit">图表数据</a>
</script>

<script  th:inline="javascript" type="text/javascript" >

    var transTotal=echarts.init(document.getElementById('main'));
    var linevalue=0;
    var name='';
    //x轴
    var xaxisdata=[];
    //series的值
    var seriestotal=[];
    //y轴
    var datacount=[];
    //lengends
    var lengends=[];
    //visualMap
    var visualVal=[];
    //登录用户名
    var use = [[${session.user.getUSE002()}]];

    $(function () {
        var url='chartuser?username='+use+'';
        layui.use('table',function () {
            var table = layui.table;
            var datasource = null;
            table.render({
                elem: '#reportext',
                url:encodeURI(url),
                method: 'post',
                ContentType: 'application/json;charset=utf-8'
                , page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                    layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                    //,curr: 5 //设定初始在第 5 页
                    , groups: 5 //只显示 1 个连续页码
                    , first: true //显示首页
                    , last: true //显示尾页
                }
                , cols: [
                    [
                        {field: 'username', title: '业务员', width: '10%', sort: true}
                        ,{field: 'lev', title: '级别', width: '10%', sort: true}
                        ,{field: 'premonth', title: '上月数量', width: '10%', sort: true}
                        ,{field: 'monthadd', title: '本月增长', width: '10%', sort: true}
                        ,{field: 'preweek', title: '上周数量', width: '10%', sort: true}
                        ,{field: 'weekadd', title: '本周增长', width: '10%', sort: true}
                        ,{field: 'preday', title: '昨天数量', width: '10%', sort: true}
                        ,{field: 'dayadd', title: '今日增长', width: '10%', sort: true}
                        ,{fixed: 'right', title: '操作', toolbar: '#barDemo', width:'20%'}
                    ]
                ],
                limits: [10, 20, 30, 40, 50],
                done: function (res, curr, count) {
                    datasource = res;
                    //如果是异步请求数据方式，res即为你接口返回的信息。
                    //如果是直接赋值的方式，res即为：{data: [], count: 99} data为当前页数据、count为数据总长度
                    // layui.msg(res);
                    //得到当前页码
                    // layui.msg(curr);
                    //得到数据总量
                    // layui.msg(count);
                }
            });
            //表格事件
            table.on('tool(reportext)', function (obj) {
                var data = obj.data;
                var username = data.username;
                if (obj.event === 'edit') {
                    btnOpenComRecord(username);
                }
            });
        });
    })

   function btnOpenComRecord(username) {
       xaxisdata=[];
       seriestotal=[];
       datacount=[];
       lengends=[];
       visualVal=[];

       $.ajax({
           type: "post",
           url: "chartuser",
           data: {"username": username},
           success: function (data) {
               if(data.avg.length<1){
                   linevalue=0;
                   name=username;
               }else{
                   var avg = data.avg;
                   linevalue = avg[0][1];
                   name = avg[0][0];
               }
               lengends.push(name);
               var item = new seriesquery(linevalue);
               var item1=new visualMapQuery(linevalue);
               var item2=new visualMapQueryOther(linevalue);

               visualVal.push(item1);
               visualVal.push(item2);
               item.name = name;
               var every = data.every;
               for (var j = 0; j < every.length; j++) {
                   xaxisdata.push(every[j][0]);
                   datacount.push(every[j][1]);
               }
               item.data = datacount;
               seriestotal.push(item);
               option1.series = seriestotal;
               option1.xAxis.data=xaxisdata;
               option1.legend.data=lengends;
               option1.visualMap.pieces=visualVal;
               transTotal.setOption(option1, true);
           }
       });
   }

    var avg=[[${avg}]];
    var every=[[${every}]];

    var seriesquery=function (item) {
        return{
                name:'',
                type: 'line',
                //smooth:true,//平滑曲线
                markLine: {
                    silent: true,
                    lineStyle: {
                        normal: {
                            color: '#ED0BEB'                   // 这儿设置安全基线颜色
                        }
                    },
                    data: [{
                        yAxis: item
                    }],
                    label: {
                        normal: {
                            formatter: '平均\n'+item        // 这儿设置安全基线
                        }
                    },
                },
            data:[]
        }
    }

    var visualMapQuery=function (item) {
        return {
                    gt: 0,
                    lte: item,          //这儿设置基线上下颜色区分 基线下面为绿色
                    color: '#e91642'
            };
    }

    var visualMapQueryOther=function (item) {
        return {
            gt: item,          //这儿设置基线上下颜色区分 基线上面为红色
            color: '#16D86E'
        };
    }

    if(avg.length<1)
    {
        linevalue=0;
        name=use;
    }else {
        linevalue=avg[0][1];
        name=avg[0][0];
    }

    var item=new seriesquery(linevalue);
    var item1=new visualMapQuery(linevalue);
    var item2=new visualMapQueryOther(linevalue);

    visualVal.push(item1);
    visualVal.push(item2);

    item.name=name;
    lengends.push(name);
   for(var j=0;j<every.length;j++) {
       xaxisdata.push(every[j][0]);
       datacount.push(every[j][1]);
   }
   item.data=datacount;
   seriestotal.push(item);

    var option1 = {
            grid: {
                left: '10%',
                right: '5%',
                bottom: '1%',
                top:'15%',
                containLabel: true
            },
            legend:{
                data:[]
            },
            xAxis: {
                type: 'category',
                name: '(日期)',
                axisTick: {           //去掉坐标轴刻线
                    show: true
                },
                axisLine:{
                    lineStyle:{
                        color:'rgba(30,130,190,0.7)'     //X轴的颜色
                    },
                },

                data:xaxisdata,
                //['张三','李四','王五','赵六','田七','粉八'],
                splitLine:{show: false}//去除网格线
            },
            visualMap: {
                show: false,//是否显示标线上下标识
                pieces: []
            },
            yAxis: {
                show:true,
                type: 'value',
                name: '(数量)',
                nameTextStyle:{
                    color:'#000'
                },
                axisTick: {//去掉坐标轴刻线
                    show: true
                },
                axisLine:{
                    lineStyle:{
                        color:'rgba(30,130,190,0.7)'         //y轴的颜色
                    },
                },
                axisLabel:{
                    show:true,
                    color:'rgba(30,130,190,0.7)'
                },
                splitLine:{show: true},//去除网格线
            },
            series: []
        };

    option1.series=seriestotal;
    option1.xAxis.data=xaxisdata;
    option1.legend.data=lengends;
    option1.visualMap.pieces=visualVal;
    transTotal.setOption(option1,true);

</script>

</html>